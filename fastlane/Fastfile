# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

# Always mantains platforms specific lanes consistant.
default_platform(:ios)

# Bump version lanes and similar doesn't belong to a platform.

desc "All ios specific lanes"
platform :ios do

    desc "Execute automatic tests and produce a code coverage report."
    lane :tests do
        run_tests(
            code_coverage: true,
            devices: ["iPhone 12 Pro Max"], # TODO: Add more devices, like "iPhone SE (1st generation) (14.5)"
            scheme: "linphone",
            workspace: "linphone.xcworkspace"
            )
    end

    desc "Prepare the build number for the next build to deploy."
    lane :prepare_version do
        prepare_version_and_build
    end

    desc "Push a new beta build to TestFlight."
    lane :beta do
        # get_certificates           # invokes cert
        # get_provisioning_profile   # invokes sigh
        prepare_version
        beta_rebranding
    end

    desc "Push a new beta build to Testflight without incrementing the build number."
    desc "Only use to publish apps for rebranding, after having incremented the main build number."
    desc "If you push without incrementing build number, it will be rejected."
    lane :beta_rebranding do
        build_app( 
            scheme: "linphone",
            silent: true,
            workspace: "linphone.xcworkspace"
            )

        notif(message: "Ready to upload...", subtitle: "Finished Building")

        upload_to_testflight(
            skip_waiting_for_build_processing: is_ci
        )
        
        notif(message: "In a few minutes, you'll be able to test your application.", subtitle: "Finished Uploading")

    end

    lane :release do
        capture_screenshots
        frame_screenshots(white: true)
        
        notif(message: "In a few minutes, you'll be able to release your application.", subtitle: "Finished Screenshotting")

        build_app
        upload_to_app_store

        notif(message: "In a few minutes, you'll be able to release your application.", subtitle: "Finished Uploading")

    end
end

desc "All Android specific lanes"
platform :android do

    desc "Run unit tests for gradle builds"
    lane :tests do
        # TODO: Replace test with the gradle task name for running unit tests of your app.
        gradle(task: "test")
        
        notif(message: "You can continue the development", subtitle: "Finished testing")
    end
end

desc "Test notif"
lane :notif do |options|
    app_icon = options[:app_icon] || "./Resources/images.xcassets/AppIcon.appiconset/1024.png"
    content_image = options[:content_image] || "./Resources/images.xcassets/AppIcon.appiconset/1024.png"
    message = options[:message] || "Your notification is shown and notify you about a new event happened in your system, generated by a lane executed by you or a script. You can interact with that if you want or ignore it. This text has to be long to test how many chars a notification message can show at the same time."
    title = options[:title] || "Fastlane Notification"

    notification(
        app_icon: app_icon,
        content_image: content_image,
        message: message,
        subtitle: options[:subtitle], 
        title: title)
end

lane :voipiu do
    lane :beta do
        get_certificates           # invokes cert
        get_provisioning_profile   # invokes sigh
        increment_build_number(xcodeproj: "linphone.xcodeproj")
        build_app( 
            scheme: "linphone",
            silent: true,
            workspace: "linphone.xcworkspace")
        notification(
            app_icon: "./Resources/images.xcassets/AppIcon.appiconset/1024.png",
            content_image: "./Resources/images.xcassets/AppIcon.appiconset/1024.png",
            subtitle: "Finished Building", 
            message: "Ready to upload...")
        upload_to_testflight
        notification(
            app_icon: "./Resources/images.xcassets/AppIcon.appiconset/1024.png",
            content_image: "./Resources/images.xcassets/AppIcon.appiconset/1024.png",
            subtitle: "Finished Uploading", 
            message: "In a few minutes, you'll be able to test your application.")
    end
end
